# Алгоритмы управления перегрузкой в Linux

## Протокол TCP: управление перегрузкой

В TCP у нас есть два типа окон: окно управления потоком (размер этого окна задаются получателем, в зависимости от того сколько места в буфере, и передается отправителю в сегментах с подтверждением) и окно перегрузки (существует на стороне отправителя, его размер рассчитывается отправителем в зависимости от того, какая нагрузка осуществляется на сеть). 

В TCP для определения размера окна перегрузки используется метод аддитивного увеличения, мультипликативного уменьшения. Суть метода заключается в том, что при получении каждого подтверждения, мы прибавляем к размеру окна некоторые значения (как правило это размер одного сегмента TCP), а если перегрузка произошла, то мы умножаем размер окна на некоторые значения (как правило 1/2). В качестве сигнала перегрузки используется потеря сегмента. Считается, что сейчас каналы связи уже хорошего качества и если произошла потеря сегмента, то не из-за ошибки канала, а из-за того, что сеть перегружена, поэтому нужно уменьшить размер окна, для того чтобы избежать дальнейшей перегрузки.

Для борьбы с перегрузками в TCP используются некоторые алгоритмы. Например:

- TCP Tahoe;
- TCP Reno/NewReno;
- TCP BIC;
- TCP CUBIC;
- Compound TCP;
- TCP BBR;
- NATCP.

Для того чтобы посмотреть какой алгоритм используется в нашей системе воспользуемся командой

```bash
sysctl net.ipv4.tcp_congestion_control
```

В дистрибутиве Ubuntu это алгоритм CUBIC.

## sysctl

sysctl - утилита для изменения параметров ядра во время выполнения. Позволяет читать и изменять параметры ядра. Значение sysctl загружаются во время загрузки системы из файла /etc/sysctl.conf. Параметры утилиты:

- переменная - Имя ключа, из которого производится чтение, к примеру kernel.ostype. Наряду с разделителем '.' поддерживается '/'.
- переменная=значение. Чтобы изменить значение ключа, используйте форму переменная=значение, где "переменная" - это изменяемый ключ, а "значение" - значение, ему присваиваемое. Если значение содержит кавычки или символы, обрабатываемые оболочкой, вам может потребоваться заключить значение в двойные кавычки. Эта форма требует использования ключа -w.

Ключи утилиты: 

- n.
Не выводить имена ключей при выводе их значений.
- e.
Игнорировать ошибки, связанные с неизвестными ключами.
- N.
Выводить только имена. Это может быть полезно для оболочек, поддерживающих настраиваемое автодополнение.
- q.
Не выводить устанавливаемые значения на стандартный вывод.
- v.
Выводить устанавливаемые значения на стандартный вывод.
- w.
Этот параметр используется для изменения значений ключей.
- p.
Загрузить настройки из указанного файла или /etc/sysctl.conf, если файл не указан.
- a.
Вывести все доступные в данный момент настройки.
- A.
Вывести все доступные в данный момент настройки в табличном виде.

## Изменение алгоритма управления перегрузкой в Linux

Посмотрим доступные алгоритмы управления перегрузкой в системе командой 

```bash
sysctl net.ipv4.tcp_available_congestion_control
```

В дистрибутиве Ubuntu доступны алгоритмы Reno и CUBIC. Изменим алгоритм управления перегрузкой командой

```bash
sudo sysctl -w net.ipv4.tcp_congestion_control=reno
```

Для того, чтобы установить алгоритмы управления перегрузкой, которых нет в tcp_available_congestion_control воспользуемся командой 

```
sudo modprobe *algorithm*
```

Например, установим vegas командой 

```bash
sudo modprobe tcp_vegas
```

Теперь в tcp_available_congestion_control появится алгоритм управления перегрузкой vegas.